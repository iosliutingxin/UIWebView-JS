"use strict";function my_scroll(){$(".wrapper_main").height($(".main_list").eq(i-1).outerHeight()),"undefined"==typeof myScroll?(myScroll=null,myScroll=new IScroll("#wrapper",{bindToWrapper:!0,click:!0,mouseWheel:!0,probeType:3,disableMouse:!0,disablePointer:!0})):myScroll.refresh()}function delay_img(){for(var elem=$("[data-src]"),i=0;i<elem.length;i++)elem.eq(i).offset().top<$(window).height()&&elem.eq(i).attr("src",elem.eq(i).attr("data-src")).removeAttr("data-src")}function andriodGoBack(){window.location.href="../home/index.html"}function clearpage(i,labelid){var string="";string+=i,string+=labelid;for(var l=0;l<a_page.length;l++)a_page[l]==string&&(a_page[l+1]=1)}function showPosition(position){var latitude=position.coords.latitude,longitude=position.coords.longitude,point=new BMap.Point(longitude,latitude),gc=new BMap.Geocoder;gc.getLocation(point,function(rs){var locationCity=rs.addressComponents.province;cityname=locationCity,cityname=cityname.indexOf("省")>0?cityname.replace(/省/g,""):cityname.indexOf("市")>0?cityname.replace(/市/,""):cityname,cityId="上海"===cityname?2:1,api.setLocalStorage("discovercity",encodeURI(cityname)),api.setLocalStorage("cityId",cityId)})}function handleLocationError(error){cityname="上海",api.setLocalStorage("discovercity",encodeURI(cityname))}function NoAppPositionInit(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(showPosition,handleLocationError,{enableHighAccuracy:!0,timeout:1e3,maximumAge:0})}api.serverVirtualDir="discover";var app=angular.module("myApp",[]),i=1,nodatano=!0,page=0,just=0,just1=0,labelid;window.swiperS=0;var myScroll;api.serverVirtualDir="discover";var city=api.getCookie("uzmCity"),cityId=1,cityname="";""!==city&&"undefined"!=typeof city&&null!==city?(cityId=decodeURI(city.split("-")[1]),api.setLocalStorage("cityId",cityId),2===cityId?api.setLocalStorage("discovercity",encodeURI("上海")):api.setLocalStorage("discovercity",encodeURI("北京")),api.setLocalStorage("cityId",cityId)):NoAppPositionInit(),$(".main_nav li").click(function(){i=$(this).index()+1,$(this).addClass("selected").siblings().removeClass("selected"),$(".wrapper_main").height($(".main_list").eq(i-1).outerHeight()),mySwiper.slideTo($(this).index()),a_page_type=!0});var mySwiper=new Swiper(".wrapper_main",{touchAngle:20,onlyExternal:!0,onSlideChangeStart:function(){$(".main_nav").eq(0).find("li").eq(mySwiper.activeIndex).addClass("selected").siblings().removeClass("selected"),$(".main_nav").eq(1).find("li").eq(mySwiper.activeIndex).addClass("selected").siblings().removeClass("selected"),$(".wrapper_main").height($(".main_list").eq(mySwiper.activeIndex).outerHeight()),my_scroll(),i=mySwiper.activeIndex+1}});my_scroll(),myScroll.on("scroll",function(){$(".main_nav").eq(1).offset().top<$(".main_nav").eq(1).height()&&"block"==$(".main_nav").eq(1).css("display")?$(".main_img1").eq(0).hasClass("div_ceng")||$(".main_nav").eq(0).show():$(".main_nav").eq(0).hide()}),api.serverVirtualDir="discover",app.controller("findCtrl",function($scope,$http,$timeout){api.serverVirtualDir="discover",$scope.loadtheme=function(){api.loading();var param=JSON.stringify({LabelId:0,OrderByField:""});"discover"!==api.serverVirtualDir&&(api.serverVirtualDir="discover"),api.post($http,$scope,api.path.msitelogic,"UzaiDiscovery","GetLabelList",param,function(obj){if(200==obj.ErrorCode||-3==obj.ErrorCode){if(-3==obj.ErrorCode&&(api.toast("网络连接失败,请重试～"),!api.isApp()))return;var result=JSON.parse(obj.JsonResult);if(void 0===$scope.labes)$scope.labes=result;else if($scope.labes!=result)for(var i=0;i<result.length;i++)$scope.labes.push(result[i]);$(".content .main").show()}else api.toast(obj.ErrorMsg,3e3)},3,!1)},$scope.loadMore=function(labelid,ordertype,pageindex,ss){api.loading(),void 0!==labelid&&0!==labelid&&null!==labelid||(labelid=0),void 0!==pageindex&&0!==pageindex&&null!==pageindex||(pageindex=1),void 0!==ordertype&&0!==ordertype&&null!==ordertype||(ordertype=""),api.serverVirtualDir="discover";var param=JSON.stringify({LabelId:labelid,OrderByField:ordertype,SubjectCount:10,PageIndex:pageindex,userId:api.getUserId(),StartCity:cityId});api.toast("一大波专题正在袭来",1e4),"discover"!==api.serverVirtualDir&&(api.serverVirtualDir="discover"),api.post($http,$scope,api.path.msitelogic,"UzaiDiscovery","GetSubjectList",param,function(obj){if($("#toast-pop").remove(),200==obj.ErrorCode||-3==obj.ErrorCode){if(-3==obj.ErrorCode)return api.toast("网络连接失败,请重试～"),!1;var result=JSON.parse(obj.JsonResult);if(result.length?(nodatano=!0,1==ordertype&&($(".data_no").eq(0).remove(),$(".main_list").eq(0).removeClass("paddt0")),2==ordertype&&($(".data_no").eq(0).remove(),$(".main_list").eq(1).removeClass("paddt0"))):(1>=page&&(nodatano=!1),api.toast("亲，只有这么多了！"),a_page_type=!1,""!==pageindex&&1!==pageindex||(1==ordertype&&($(".main_list").eq(0).hasClass("paddt0")||$(".main_list").eq(0).append("<div class='data_no'>暂无数据</div>"),$(".main_list").eq(0).addClass("paddt0"),$(".wrapper_main").height($(".main_list").eq(0).outerHeight())),2==ordertype&&($(".main_list").eq(1).hasClass("paddt0")||$(".main_list").eq(1).append("<div class='data_no'>暂无数据</div>"),$(".main_list").eq(1).addClass("paddt0"),$(".wrapper_main").height($(".main_list").eq(1).outerHeight())),my_scroll())),1==ordertype){if(ss===!0&&($scope.subjectlist=[]),void 0===$scope.subjectlist)$scope.subjectlist=result;else if($scope.subjectlist!==result)for(var i=0;i<result.length;i++)$scope.subjectlist.push(result[i]);for(var j=$scope.subjectlist.length-1;j>=0;j--)if("string"==typeof $scope.subjectlist[j].Labels){var arr=$scope.subjectlist[j].Labels.split(",");if(","===$scope.subjectlist[j].Labels||""===$scope.subjectlist[j].Labels){$scope.subjectlist[j].Labels=[];continue}$scope.subjectlist[j].Labels=arr}}if(2==ordertype){if(ss===!0&&($scope.subjectlist2=[]),void 0===$scope.subjectlist2)$scope.subjectlist2=result;else if($scope.subjectlist2!=result)for(var j=0;j<result.length;j++)$scope.subjectlist2.push(result[j]);for(var j=$scope.subjectlist2.length-1;j>=0;j--)if("string"==typeof $scope.subjectlist2[j].Labels){var arr=$scope.subjectlist2[j].Labels.split(",");if(","===$scope.subjectlist2[j].Labels||""===$scope.subjectlist2[j].Labels){$scope.subjectlist2[j].Labels="";continue}$scope.subjectlist2[j].Labels=arr}}if(setTimeout(delay_img,100),api.getLocalStorage("popularity_or_new")&&0===just){var label=api.getLocalStorage("popularity_or_new");0===api.getLocalStorage("label")&&(label=1),setTimeout(function(){$(".main_nav").eq(0).find("li").eq(label-1).click(),$(".main_nav").eq(1).find("li").eq(label-1).click()},100),just=1}setTimeout(function(){api.removeLocalStorage("popularity_or_new"),api.removeLocalStorage("label")},4e3),0===just1&&($(".content .main").show(),mySwiper=new Swiper(".wrapper_main",{touchAngle:20,onlyExternal:!0,onSlideChangeStart:function(){$(".main_nav").eq(0).find("li").eq(mySwiper.activeIndex).addClass("selected").siblings().removeClass("selected"),$(".main_nav").eq(1).find("li").eq(mySwiper.activeIndex).addClass("selected").siblings().removeClass("selected"),$(".wrapper_main").height($(".main_list").eq(mySwiper.activeIndex).outerHeight()),my_scroll(),i=mySwiper.activeIndex+1}}),just1=1)}else api.toast(obj.ErrorMsg,3e3)},3,!1)},$scope.jumptoActive=function(data){var id=data.value2.Id,url=data.value2.DetailUrl,param=JSON.stringify({LabelId:id});api.post($http,$scope,api.path.msitelogic,"UzaiDiscovery","UpdateVisitsNum",param,function(obj){},3,!1),api.setLocalStorage("popularity_or_new",i),api.setLocalStorage("label",labelid),window.location.href=url},$scope.loadMorelist=function(labelid){api.loading();var pageindex=1;api.serverVirtualDir="discover";var param=JSON.stringify({LabelId:labelid,StartCity:cityId});api.toast("一大波专题正在袭来",1e4),"discover"!==api.serverVirtualDir&&(api.serverVirtualDir="discover"),api.post($http,$scope,api.path.msitelogic,"UzaiDiscovery","GetSubjectByID",param,function(obj){if($("#toast-pop").remove(),200==obj.ErrorCode||-3==obj.ErrorCode){if(-3==obj.ErrorCode)return api.toast("网络连接失败,请重试～"),!1;var result=JSON.parse(obj.JsonResult).subjectlist1,result2=JSON.parse(obj.JsonResult).subjectlist2;result.length?(nodatano=!0,$(".data_no").eq(0).remove(),$(".main_list").eq(0).removeClass("paddt0"),$(".main_list").eq(1).removeClass("paddt0")):(1>=page&&(nodatano=!1),api.toast("亲，只有这么多了！"),a_page_type=!1,""!==pageindex&&1!==pageindex||($(".main_list").eq(0).hasClass("paddt0")||$(".main_list").eq(0).append("<div class='data_no'>暂无数据</div>"),$(".main_list").eq(0).addClass("paddt0"),$(".wrapper_main").height($(".main_list").eq(0).outerHeight()),$(".main_list").eq(1).hasClass("paddt0")||$(".main_list").eq(1).append("<div class='data_no'>暂无数据</div>"),$(".main_list").eq(1).addClass("paddt0"),$(".wrapper_main").height($(".main_list").eq(1).outerHeight()),my_scroll())),$timeout(function(){$scope.subjectlist=result,$scope.subjectlist2=result2;for(var j=$scope.subjectlist.length-1;j>=0;j--)if("string"==typeof $scope.subjectlist[j].Labels){var arr=$scope.subjectlist[j].Labels.split(",");if(","===$scope.subjectlist[j].Labels||""===$scope.subjectlist[j].Labels){$scope.subjectlist[j].Labels=[];continue}$scope.subjectlist[j].Labels=arr}for(var j=$scope.subjectlist2.length-1;j>=0;j--)if("string"==typeof $scope.subjectlist2[j].Labels){var arr=$scope.subjectlist2[j].Labels.split(",");if(","===$scope.subjectlist2[j].Labels||""===$scope.subjectlist2[j].Labels){$scope.subjectlist2[j].Labels=[];continue}$scope.subjectlist2[j].Labels=arr}},1),setTimeout(delay_img,100)}},3,!1)}}),app.directive("findDir",function(){return{restrict:"AE",link:function(scope,elm,attr){if(scope.$last===!0&&(swiperS=new Swiper(".swiper-containerS",{slidesPerView:"auto"}),api.getLocalStorage("popularity_or_new"))){var label=api.getLocalStorage("label");setTimeout(function(){var label_index=$(".swiper-wrapper .main_img1").index($("[data-id="+label+"]").parent());$(".swiper-wrapper .main_img1").eq(label_index).addClass("div_ceng").siblings().removeClass("div_ceng"),swiperS=new Swiper(".swiper-containerS",{slidesPerView:"auto",initialSlide:label_index}),0!==label_index?($(".main_nav").eq(1).show(),$(".wrapper").css("top","3.58rem")):($(".main_nav").eq(1).hide(),$(".wrapper").css("top","2.7rem"))},100)}scope.$first===!0&&(api.getLocalStorage("popularity_or_new")||elm.addClass("div_ceng")),elm.on("click",function(){$(this).addClass("div_ceng").siblings().removeClass("div_ceng"),labelid=$(this).children("img").attr("data-id"),clearpage(1,labelid),clearpage(2,labelid),a_page_type=!0,0!==$(this).index()?($(".main_nav").eq(1).show(),scope.loadMorelist(labelid),$(".wrapper").css("top","3.58rem"),$(".main_nav li").eq(0).click()):($(".main_nav").eq(1).hide(),scope.loadMore("",1,"",!0),$(".wrapper").css("top","2.7rem"),$(".main_nav li").eq(0).click()),myScroll.scrollTo(0,0,200)})}}}),app.directive("findDir1",function(){return{restrict:"AE",link:function(scope,elm,attr){scope.$last===!0&&setTimeout(my_scroll,100)}}}),app.directive("findDir2",function(){return{restrict:"AE",link:function(scope,elm,attr){scope.$last===!0&&setTimeout(my_scroll,100)}}});var a_page=[],a_page_type=!0,pointY=1;app.directive("loadMore",function(){return{restrict:"AE",link:function(scope,elm,attr){window.y=0,scope.loadtheme(),api.getLocalStorage("popularity_or_new")?(labelid=api.getLocalStorage("label"),scope.loadMore(labelid,1),0!==labelid&&scope.loadMore(labelid,2)):(labelid=0,scope.loadMore("",1)),myScroll.on("scroll",function(){window.y=this.y,window.pointY=this.pointY}),$("#wrapper").on("touchmove",function(event){return pointY>=window.innerHeight-1?(myScroll.scrollTo(0,0,100),!1):0>=pointY?(myScroll.scrollTo(0,myScroll.maxScrollY,100),!1):void 0}),$("#wrapper").on("touchend",function(){if(window.y>=10&&(clearpage(i,labelid),a_page_type=!0,nodatano&&scope.loadMore(labelid,i,"",!0)),-window.y+$("#wrapper").height()-$(".wrapper_main").innerHeight()>=0&&a_page_type){for(var pagetype=!0,l=0;l<=a_page.length;l++)a_page[l]==i.toString()+window.labelid&&(a_page[l+1]=parseInt(a_page[l+1])+1,page=a_page[l+1],pagetype=!1);pagetype&&(a_page.push(i.toString()+window.labelid),a_page[a_page.length]=2,page=a_page[a_page.length-1]),nodatano&&scope.loadMore(window.labelid,i,page)}1==myScroll.directionY&&window.y<=-20&&window.y>=-$(".main_img").innerHeight()&&myScroll.scrollTo(0,-$(".main_img").innerHeight(),1e3)})}}}),myScroll.on("scrollEnd",delay_img),window.androidGoBack=andriodGoBack,window.andriodGoBack=andriodGoBack;