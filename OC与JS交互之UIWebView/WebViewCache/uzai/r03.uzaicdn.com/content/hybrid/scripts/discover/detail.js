"use strict";function androidGoBack(){try{ga("send","event","TopicDetailPage","back","back")}catch(err){}bridge.goBack("",!0,!1,1)}function showPosition(position){var latitude=position.coords.latitude,longitude=position.coords.longitude,point=new BMap.Point(longitude,latitude),gc=new BMap.Geocoder;gc.getLocation(point,function(rs){var locationCity=rs.addressComponents.province;cityname=locationCity,cityname=cityname.indexOf("省")>0?cityname.replace(/省/g,""):cityname.indexOf("市")>0?cityname.replace(/市/,""):cityname,startCityId="上海"===cityname?2:1})}function handleLocationError(error){cityname="上海",api.setLocalStorage("discovercity",encodeURI(cityname))}function NoAppPositionInit(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(showPosition,handleLocationError,{enableHighAccuracy:!0,timeout:1e3,maximumAge:0})}function productDetailResize(){var html=document.documentElement,windowWidth=html.clientWidth;html.style.fontSize=windowWidth/7.5+"px";var windowHeight=$(window).height();$("body").height(windowHeight)}api.__asyncLoadingCode__="0",api.isApp()?api.backUrl='javascript:bridge.goBack("", true, false, 1);':""===document.referrer&&(api.backUrl="https://m.uzai.com/discover/index.html"),api.loading();var myScroll,favoriteid="0",startCityId="2",startCity=" 上海",cityname="上海",userid=0;$.fn.detail=function(){function loadd(){myScroll=new IScroll("#wrapper",{scrollX:!0,freeScroll:!0,click:!0,disableMouse:!0,disablePointer:!0}),myScroll.on("scroll",scrollaction),myScroll.on("scrollEnd",scrollaction),setTimeout(function(){lazy()},100),myScroll.refresh()}function lazy(){for(var len=$("li img").length,i=0;len>i;i++)$("li img").eq(i).offset().top<-1*myScroll.y+$(window).height()&&$("li img").eq(i).attr("src",$("li img").eq(i).attr("data-url"))}function scrollaction(){setTimeout(function(){lazy()},1)}function sizeset(){var adressName=$(".three-span").text();adressName.length>7&&$(".three-span").css("font-size","0.18rem")}function inits(){var ua=navigator.userAgent,ipad=ua.match(/(iPad).*OS\s([\d_]+)/),isIphone=!ipad&&ua.match(/(iPhone\sOS)\s([\d_]+)/),isAndroid=ua.match(/(Android)\s+([\d.]+)/);window.isMobile=isIphone||isAndroid}inits(),sizeset(),loadd()};var cityId,app=angular.module("myApp",[]);app.controller("topDetail",function($scope,$http){if(api.serverVirtualDir="discover",api.isApp())startCity=api.getQueryString("startcity"),userid=api.getQueryString("disu"),null!==startCity&&startCity.length>0&&("上海"===startCity?(startCityId="2",cityId="2"):(startCityId="1",cityId="1"));else{var city=api.getCookie("uzmCity");if(userid=api.getUser().userId,""!==city&&"undefined"!=typeof city){if(""!==city.split("-")&&"undefined"!=typeof city.split("-"))try{cityId=decodeURI(city.split("-")[1]),startCityId=cityId}catch(error){}}else"undefined"!==api.getLocalStorage("cityId")&&""!==api.getLocalStorage("cityId")?startCityId=api.getLocalStorage("cityId"):(NoAppPositionInit(),setTimeout(function(){},3e3))}$scope.isShow=api.isApp();var subjectId=api.getQueryString("subjectid"),RequestFrom=api.getQueryString("RequestFrom"),param=JSON.stringify({ProductId:subjectId,SubjectId:subjectId,StartCity:startCityId,RequestFrom:RequestFrom,UserId:userid});api.post($http,$scope,api.path.msitelogic,"DiscoveryDetail","RecommendProducts",param,function(obj){if(200==obj.ErrorCode||-3==obj.ErrorCode){if(-3==obj.ErrorCode&&(api.toast(obj.ErrorMsg),$scope.backshow=!0,!api.isApp()))return;$scope.backshow=!0,$scope.pricerangeid=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.PriceRange,$scope.daysid=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.Days,$scope.pricerange=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.PriceRangeText,$scope.days=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.DaysText,$scope.coverImg=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.ImgUrl,$scope.subjectarea=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.Area,$scope.labellist=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.LabelList,$scope.subjectname=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.SubjectName,$scope.products=JSON.parse(obj.JsonResult).DiscoverySubjectProductInfo,$scope.subjectdesc=JSON.parse(obj.JsonResult).DiscoverySubjectInfo.DetailsDesc,$scope.pageUrl=JSON.parse(obj.JsonResult).PageUrl;var maxDay="";""!==$scope.days&&"undefined"!=typeof $scope.days&&(maxDay="11天以上"!==$scope.days&&"不限"!==$scope.days?9!==$scope.days.substring(0,1)?$scope.days.substring(2,3):$scope.days.substring(3,5):"11"),$scope.title=$scope.subjectarea+maxDay+"价格 - "+$scope.subjectname+"- 众信悠哉旅游",$scope.keyWord=$scope.subjectarea+maxDay+"日游价格,",$scope.keyWord+=$scope.subjectarea+maxDay+"日游线路推荐,",$scope.keyWord+=$scope.subjectarea+maxDay+"日游线路",$scope.headcontent="",""!==$scope.subjectdesc&&"undefined"!=typeof $scope.subjectdesc&&($scope.headcontent=$scope.subjectdesc.substring(0,130)),$("title").html($scope.title),$('meta[name="keywords"]').attr("content",$scope.keyWord),$('meta[name="description"]').attr("content",$scope.headcontent),$scope.isProductsAny=!1,""!==$scope.products&&"undefined"!=typeof $scope.products&&$scope.products.length>0&&($scope.isProductsAny=!0);var num=1;if("不限"!==$scope.days&&""!==$scope.days?($scope.daysShow=!0,num++):$scope.daysShow=!1,"不限"!==$scope.pricerange&&""!==$scope.pricerange?($scope.pricerangeShow=!0,num++):$scope.pricerangeShow=!1,$scope.hover=num,$scope.hover>=1?$scope.hover1=!0:$scope.hover1=!1,$scope.hover>=2?$scope.hover2=!0:$scope.hover2=!1,3==$scope.hover?$scope.hover3=!0:$scope.hover3=!1,$("#wrapper").detail(),setTimeout(function(){myScroll.refresh()},1),obj.JsonResult=null,$("#secondAre").show(),$scope.isshow=!0,api.setLocalStorage("disu",userid),api.isApp()&&void 0!==userid)if(userid>0){var isFavoriteParam=JSON.stringify({ProductId:subjectId,SubjectId:subjectId,UserId:userid});api.post($http,$scope,api.path.msitelogic,"MyFavorite","IsSubjectFavorited",isFavoriteParam,function(favobj){200==favobj.ErrorCode||-3==favobj.ErrorCode?(-3==favobj.ErrorCode&&api.toast(favobj.ErrorMsg),favoriteid=favobj.JsonResult,"0"!==favoriteid?$(".collection").addClass("collectioned"):$(".collection").removeClass("collectioned")):api.toast(favobj.ErrorMsg)},0,!1)}else $(".collection").removeClass("collectioned");else $(".collection").removeClass("collectioned");api.endloading()}else $scope.backshow=!0,api.endloading(),api.toast(obj.ErrorMsg)},3,!1),$scope.addSubjectToFavorite=function(){if("0"===favoriteid){bridge.addSubjectToFavorite();try{ga("send","event","TopicDetailPage","collect","收藏")}catch(err){}}else{bridge.cancelSubjectFavorite(favoriteid);try{ga("send","event","TopicDetailPage","collect","cancel")}catch(err){}}},$scope.shareSubject=function(title,content,imageUrl,pageUrl){if(content="【"+title+"】"+content,content.length+pageUrl.length>136){var allowedLength=136-pageUrl.length-6;pageUrl.length<136&&content.length>allowedLength&&(content=content.substring(0,allowedLength)+"...")}bridge.shareSubject(title,content,imageUrl,pageUrl)},$scope.openProductDetail=function(productId,UzaiTravelClassID,productType){try{ga("send","event","TopicDetailPage","recommend products","recommend products")}catch(err){}bridge.openProduct(UzaiTravelClassID,productId,productType)},$scope.openSearch=function(prices,days,searchContent){try{ga("send","event","TopicDetailPage","anchor","anchor")}catch(err){}"undefined"!=typeof api.getQueryString("subjectid")&&null!==api.getQueryString("subjectid")&&api.setCookie("searchresultbackurl","https://m.uzai.com/discover/detail.html?subjectid="+api.getQueryString("subjectid"));var price="";1===prices?price="1-500":2===prices?price="501-1000":3===prices?price="1001-3000":4===prices?price="3001-5000":5===prices?price="5001-8000":6===prices?price="8001-10000":7===prices&&(price="10001-0");var day="";1===days?day="1,2":2===days?day="3,4,5":3===days?day="6,7,8":4===days?day="9,10,11":5===days&&(day="11,12,13,14,15,16,17,18,19,20"),0===prices&&(prices=""),0===days&&(day=""),bridge.openSearch(searchContent,null,day,price,cityId,null,null,prices,days,null,null,null,null,null,null,null)},$scope.callback=function(url,islastpage,isrootpage){try{ga("send","event","TopicDetailPage","back","back")}catch(err){}bridge.goBack(url,islastpage,isrootpage,1)}}),app.filter("trustHtml",function($sce){return function(input){return $sce.trustAsHtml(input)}}),window.onload=function(){},window.addSubjectToFavoriteResponse=function(code,operate,result){api.setLocalStorage("response",code),"200"===code?"1"===operate?($(".collection").addClass("collectioned"),favoriteid=result,api.toast("收藏成功")):(favoriteid="0",$(".collection").removeClass("collectioned"),api.toast("取消收藏成功")):"1"===operate?api.toast("收藏失败"):api.toast("取消收藏失败")},window.androidGoBack=androidGoBack,window.addEventListener("orientationchange",function(){productDetailResize()},!1);