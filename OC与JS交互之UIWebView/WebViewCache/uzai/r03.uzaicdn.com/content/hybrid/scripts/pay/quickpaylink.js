!function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:!1};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.loaded=!0,module.exports}var installedModules={};return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.p="",__webpack_require__(0)}([function(module,exports,__webpack_require__){"use strict";function popup(text){void 0===text&&(text=""),$(".popup").show(),$(".popup span").html(text),setTimeout(function(){$(".popup").fadeOut()},2e3)}var _paycommon=__webpack_require__(1),uzai=angular.module("uzai",[]),Pay_subpage={create:function(){var Pay_subpage={init:function(){this.selectBank(),this.selectCoupons()},selectCoupons:function(){$(".choose-coupons .right .circle").click(function(){var $this=$(this);$this.hasClass("active")?$this.toggleClass("active"):$this.addClass("active").parents(".choose-coupons").siblings(".choose-coupons").find(".circle").removeClass("active")})},selectBank:function(){$(".bank-red-bg .circle").click(function(){var $this=$(this);$this.addClass("active").find("i").show().parents(".bank-red-bg").siblings(".bank-red-bg").find(".bank-discount .circle").removeClass("active").find("i").hide()})}};return Pay_subpage}},_paySubpage=Pay_subpage.create();_paySubpage.init();var childrenFunction={paycoupons:function(){$("body").on("focus",".coupons-search input",function(){var $this=$(this);window.$close=$this.next(),$this.prev().hide().end().next().show()}).on("blur",".coupons-search input",function(){var $this=$(this),$into=$(".search .into"),$val=$this.val();return window.$close=$this.next(),""===$val?$into.show().siblings(".close").hide():""}).on("input",".coupons-search input",function(){var $this=$(this),$button=$this.parents(".search").siblings(".button");return $this.val().length>6?$button.addClass("active"):$button.removeClass("active")}).on("click",".coupons-header .mark",function(){$(".cal-mask1").show(),$("#cal-pop").fadeIn()}).on("click","#cal-pop .icon-close,#cal-pop .icon-guanbi,#cal-pop .icon-guanbi,.cal-mask",function(){$(".cal-mask1").fadeOut(),$("#cal-pop").hide()})},bankdiscount:function(){}};window.childrenFunction=window.childrenFunction||childrenFunction,function(window,document,$,uzai,BookingSub){uzai.controller("Payment",function($http,$scope,$compile){function hanlderResponse(response){return 200===response.ErrorCode?!0:-3===response.ErrorCode?(api.toast("网络连接失败,请重试～"),!1):(-5===response.ErrorCode&&(api.toast(response.ErrorMsg,2e3),$scope.showPreferentials=!1,$scope.getBanksAndPreferentials()),-6===response.ErrorCode?($scope.showError=!0,!1):(api.toast(response.ErrorMsg,2e3),!1))}var $paycommon=new _paycommon.PayCommon($http,$scope);angular.element(document).ready(function(){api.router($http,$scope,$compile,"1")});var userId=api.getCookie("EncyQuickLink"),orderCode=document.getElementById("_hdordercode").value,expireTime=document.getElementById("_hdexpiretime").value,devicetype=api.getQueryString("devicetype")||"wap",tuanId=api.getQueryString("tuanId"),isSonOrder=!1;if(null!==expireTime&&""!==expireTime&&"undefined"!=typeof expireTime&&parseInt(expireTime)>7)return void api.toast("该支付链接已过期!",2e3);var PointRatio=50;$scope.getBanksAndPreferentials=function(){var parameters=JSON.stringify({userid:userId,orderCode:orderCode,terminaltype:devicetype||"wap"});$paycommon.GetBankPreferentialList(parameters,function(paymentInfo){function CaseTost(){if($scope.paymentInfo&&!$scope.paymentInfo.PrefIsExpired&&""!=$scope.paymentInfo.PreferentialName){if(!$scope.isshowapplepay&&$scope.isios&&$scope.paymentInfo.IsBankPref&&$scope.paymentInfo.IsPayPreferential){if($scope.paymentInfo.IsApplePayBankPref)return $scope.CaseTost=3}else if(!$scope.paymentInfo.IsPayPreferential)return $scope.CaseTost=1}else if($scope.paymentInfo&&$scope.paymentInfo.PrefIsExpired&&""!=$scope.paymentInfo.PreferentialName)return $scope.CaseTost=2}$scope.paymentInfo=paymentInfo,$scope.pointInfo={point:$scope.paymentInfo.Jifen<0?Math.abs($scope.paymentInfo.Jifen):0,totalPoint:0,pointText:"",pointMoney:Math.abs($scope.paymentInfo.Jifen)/PointRatio,usePoint:Math.abs($scope.paymentInfo.Jifen)>0,disabled:Math.abs($scope.paymentInfo.Jifen)>0},$scope.activeCodeInfo={couponsPrice:Math.abs($scope.paymentInfo.ActiveCode),isUseCoupons:Math.abs($scope.paymentInfo.ActiveCode)>0,disabled:Math.abs($scope.paymentInfo.ActiveCode)>0||1===$scope.paymentInfo.OrderDetail.UzaiOrder.UzaiProcutBehavior||3===$scope.paymentInfo.OrderDetail.UzaiOrder.UzaiProcutBehavior,couponsCode:"",couponsType:0},$scope.orderPrepayMent=0,$scope.paymentInfo.OrderDetail.UzaiOrder&&($scope.paymentInfo.OrderDetail.UzaiOrderSonList&&$scope.paymentInfo.OrderDetail.UzaiOrderSonList.length>0&&(isSonOrder=!0),$scope.orderPrepayMent=(1e3*$scope.paymentInfo.OrderDetail.UzaiOrder.PrepayMent-1e3*$scope.paymentInfo.PreferentialMoney)/1e3,isSonOrder&&($scope.orderPrepayMent=1e3*$scope.paymentInfo.OrderDetail.UzaiOrder.PrepayMent/1e3),$scope.paymentInfo.OrderDetail.OrderModifyPrices&&$scope.paymentInfo.OrderDetail.OrderModifyPrices.length>0&&($scope.additionalExtras=$scope.paymentInfo.OrderDetail.OrderModifyPrices.filter(function(modifyPrice){return modifyPrice.ModefyPirce>0}),$scope.preferentialExtras=$scope.paymentInfo.OrderDetail.OrderModifyPrices.filter(function(modifyPrice){return modifyPrice.ModefyPirce<=0}))),$scope.showAllBanks=!$scope.paymentInfo.IsPayPreferential||$scope.paymentInfo.PrefIsExpired||$scope.paymentInfo.Banks.every(function(bank){return!bank.PayPreferentials||!bank.PayPreferentials[0]||!bank.PayPreferentials[0].IsCheck}),$scope.currentBank=$scope.paymentInfo.Banks&&$scope.paymentInfo.Banks.filter(function(bank){return bank.PayPreferentials&&bank.PayPreferentials[0]&&bank.PayPreferentials[0].IsCheck})[0],void 0!==$scope.currentBank&&null!==$scope.currentBank.PayPreferentials&&($scope.orderPrepayMent=(1e3*$scope.paymentInfo.OrderDetail.UzaiOrder.PrepayMent-1e3*$scope.currentBank.PayPreferentials.map(function(item){return item.PreferentialMoney}).reduce(function(a,b){return a+b},0))/1e3),CaseTost(),$paycommon.gaStatistics($scope.paymentInfo,orderCode)},0,!1)};var hrefulr=window.location.href;hrefulr.indexOf("#/paycoupons")>-1&&(location.href="#/"),setTimeout(function(){$scope.getBanksAndPreferentials()},0),$scope.calculatePrice=function(){var price=$scope.paymentInfo.OrderDetail.UzaiOrder.PrepayMent;if($scope.currentBank&&$scope.currentBank.PayPreferentials){if($scope.currentBank.PayPreferentials.length>0){var calculatePreferentials=$scope.currentBank.PayPreferentials.filter(function(item){return 1!==item.Source});price=(1e3*price-1e3*calculatePreferentials.map(function(item){return item.PreferentialMoney}).reduce(function(a,b){return a+b},0))/1e3}}else $scope.isPayPreferential&&$scope.orderDetail&&$scope.orderDetail.UzaiPreferentialRecord&&(price=(1e3*$scope.paymentInfo.OrderDetail.UzaiOrder.PrepayMent-1e3*$scope.paymentInfo.PreferentialMoney)/1e3,isSonOrder&&(price=1e3*$scope.paymentInfo.OrderDetail.UzaiOrder.PrepayMent/1e3));$scope.activeCodeInfo.isUseCoupons&&!$scope.activeCodeInfo.disabled&&(price=(1e3*price-1e3*$scope.activeCodeInfo.couponsPrice)/1e3),$scope.pointInfo.disabled||$scope.changePoint(price),$scope.pointInfo.usePoint&&!$scope.pointInfo.disabled&&(price=(1e3*price-1e3*Math.abs($scope.pointInfo.pointMoney))/1e3),$scope.orderPrepayMent=price},$scope.setShowAllBanks=function(showAllBanks){$scope.showAllBanks=showAllBanks};var hasQueryPoint=!1;$scope.changeBank=function(bankId){var lastBank=$scope.preBank=$scope.currentBank,newBank=$scope.currentBank=$scope.paymentInfo.Banks.filter(function(bank){return bank.BankID===bankId})[0];$scope.showAllBanks&&($scope.showAllBanks=!1);var payPrefer=function(bank){return bank&&bank.PayPreferentials&&0!==bank.PayPreferentials.length&&bank.PayPreferentials&&bank.PayPreferentials.length>0?bank.PayPreferentials.map(function(item){return item.PreferentialMoney}).reduce(function(pre,current){return pre+current},0):0};$scope.extraMoney=payPrefer(lastBank)-payPrefer(newBank),$scope.showExtraMoneyMask=$scope.extraMoney>0;var parameters=JSON.stringify({userid:userId,productId:$scope.paymentInfo.OrderDetail.UzaiOrder.ProductId,beginDate:$scope.paymentInfo.OrderDetail.UzaiOrder.GoDate}),setPointDisabled=function(){$scope.pointInfo.point=0,$scope.pointInfo.pointMoney=0,$scope.pointInfo.usePoint=!1},setCardDisabled=function(){$scope.activeCodeInfo.couponsPrice=0,$scope.activeCodeInfo.couponsCode="",$scope.activeCodeInfo.couponsType=0,$scope.activeCodeInfo.isUseCoupons=!1};if(isSonOrder)setPointDisabled(),$scope.lijianPreferential=void 0,$scope.showPreferentials=!1,$(".payment .discount-con").hide();else if($scope.currentBank.PayPreferentials&&$scope.currentBank.PayPreferentials[0]&&1===$scope.currentBank.PayPreferentials[0].PreferentialType)setPointDisabled(),setCardDisabled(),$scope.lijianPreferential=void 0,$scope.showPreferentials=!1;else if(hasQueryPoint||$scope.pointInfo.disabled||(api.post($http,$scope,api.path.mbuylogic,"MemberPoint","GetMemberPointsAndCheckPoint",parameters,function(data){hanlderResponse(data)&&(data=JSON.parse(data.JsonResult),$scope.pointInfo.totalPoint=data.Point||0,$scope.pointInfo.disabled=$scope.pointInfo.disabled||Math.abs(data.IsChackPoint)<=0,$scope.changePoint($scope.orderPrepayMent))},0,!1),hasQueryPoint=!0),$scope.showPreferentials=!0,$scope.pointInfo.disabled&&$scope.activeCodeInfo.disabled&&(null===$scope.currentBank.PayPreferentials||0===$scope.currentBank.PayPreferentials.length)&&($scope.showPreferentials=!1),$scope.lijianPreferential=void 0,$scope.currentBank.PayPreferentials&&$scope.currentBank.PayPreferentials[0]&&($scope.lijianPreferential=$scope.currentBank.PayPreferentials.filter(function(preferential){return 2===preferential.PreferentialType})[0],$scope.currentBank.PayPreferentials.filter(function(preferential){return 1===preferential.Source&&2===preferential.PreferentialType}).length>0&&($scope.activeCodeInfo.disabled=!0)),$scope.lijianPreferential&&$scope.activeCodeInfo.isUseCoupons)for(var i=0;i<$scope.currentBank.PayPreferentials.length;i++){var preferential=$scope.currentBank.PayPreferentials[i];preferential.PreferentialId===$scope.lijianPreferential.PreferentialId&&$scope.currentBank.PayPreferentials.splice(i,1)}$scope.showExtraMoneyMask||$scope.calculatePrice()},$scope.setBankClass=function(bank){var bankClass="hide";return void 0!==$scope.currentBank&&$scope.currentBank.BankID===bank.BankID?bankClass="on":(void 0===$scope.currentBank&&bank.PayPreferentials[0]&&bank.PayPreferentials[0].IsCheck&&(bankClass="on"),$scope.showAllBanks&&(bankClass="")),bankClass},$scope.cancelChange=function(){$scope.showExtraMoneyMask=!1,$scope.showPreferentials=!1,$scope.currentBank=$scope.preBank},$scope.confirmPay=function(){$scope.showExtraMoneyMask=!1,$scope.calculatePrice()},$scope.selectCard=function(isrefresh){if((void 0===$scope.useableCards||null===$scope.useableCards)&&(void 0===$scope.disableCards||null===$scope.disableCards)||isrefresh){var param=JSON.stringify({userId:userId,productId:$scope.paymentInfo.OrderDetail.UzaiOrder.ProductId,prepayMent:$scope.paymentInfo.OrderDetail.UzaiOrder.TotalPrice,cityId:$scope.paymentInfo.OrderDetail.UzaiOrder.StartCity,sumPerson:$scope.paymentInfo.OrderDetail.UzaiOrder.Person+$scope.paymentInfo.OrderDetail.UzaiOrder.Child,platfrom:encodeURI(api.isApp()?"UZ_APP":"UZ_MOBILE")});api.post($http,$scope,api.path.mbuylogic,"Coupons","GetCouponsListByUserID",param,function(data){hanlderResponse(data)&&(data=JSON.parse(data.JsonResult),$scope.useableCards=data.keyongList,$scope.disableCards=data.bukeyongList)},0,!1)}},$scope.addcoupons=function($event){var classname=$event.target.getAttribute("class");if("button active"===classname){var activecode=$(".coupons").find("[type=text]").val(),param=JSON.stringify({userId:userId,productId:$scope.paymentInfo.OrderDetail.UzaiOrder.ProductId,prepayMent:$scope.paymentInfo.OrderDetail.UzaiOrder.TotalPrice,cityId:$scope.paymentInfo.OrderDetail.UzaiOrder.StartCity,sumPerson:$scope.paymentInfo.OrderDetail.UzaiOrder.Person+$scope.paymentInfo.OrderDetail.UzaiOrder.Child,platfrom:api.isApp()?"UZ_APP":"UZ_MOBILE",uActiveCode:activecode});if($scope.VerificationUActiveCode())return void api.toast("优惠券已存在");api.post($http,$scope,api.path.mbuylogic,"Coupons","AddCoupons",param,function(data){if(200===data.ErrorCode)api.toast(data.ErrorMsg),$(".search").find("input").val(""),$(".coupons").find(".button").removeClass("active"),$scope.useableCards.unshift(JSON.parse(data.JsonResult));else{if(201!==data.ErrorCode)return void api.toast(data.ErrorMsg);api.toast(data.ErrorMsg),$(".search").find("input").val(""),$(".coupons").find(".button").removeClass("active"),$scope.disableCards.unshift(JSON.parse(data.JsonResult))}},0,!1)}},$scope.VerificationUActiveCode=function(){for(var isExixt=!1,activecode=$(".coupons").find("[type=text]").val().toLowerCase(),i=0;i<$scope.useableCards.length;i++)$scope.useableCards[i].UActiveCode.toLowerCase()===activecode&&(isExixt=!0);for(var _i=0;_i<$scope.disableCards.length;_i++)$scope.disableCards[_i].UActiveCode.toLowerCase()===activecode&&(isExixt=!0);return isExixt},$scope.closeCard=function(){$(".cal-mask").fadeOut(),$("#cal-pop").hide()},$scope.pointExplain=function(){$scope.showPoint=!0},$scope.choosePoint=function(){$scope.pointInfo.usePoint=!$scope.pointInfo.usePoint,$scope.calculatePrice()},$scope.changePoint=function(price){$scope.pointInfo.point=parseInt($scope.pointInfo.totalPoint/PointRatio<price?$scope.pointInfo.totalPoint:(price-1)*PointRatio),$scope.pointInfo.pointMoney=Math.abs(parseInt($scope.pointInfo.point/PointRatio))||0,$scope.pointInfo.pointText=$scope.pointInfo.totalPoint,1e4===$scope.pointInfo.totalPoint?$scope.pointInfo.pointText=String($scope.pointInfo.totalPoint).substring(0,String($scope.pointInfo.totalPoint).length-4)+"万":String($scope.pointInfo.totalPoint).length>4&&($scope.pointInfo.pointText=String($scope.pointInfo.totalPoint).substring(0,String($scope.pointInfo.totalPoint).length-4)+"万＋")},$scope.pay=function(){if(!$scope.currentBank)return void api.toast("请选择一种支付方式");if($scope.orderPrepayMent<=0)return void popup("优惠大于应付金额请联系客服协助您预订");var needCheck=!0;if(null!==$scope.paymentInfo.OrderDetail.UzaiOrderSonList&&$scope.paymentInfo.OrderDetail.UzaiOrderSonList.length>0){var paiedSonOrder=$scope.paymentInfo.OrderDetail.UzaiOrderSonList.filter(function(sonOrder){return 1===sonOrder.State})[0];paiedSonOrder&&(needCheck=!1)}if(needCheck&&$scope.paymentInfo.IsSplitSingle&&$scope.paymentInfo.PrefIsExpired)return void popup("优惠已下线，无法完成支付，请联系客服");var preferentialIds="",preferentialTotalMoney="";if($scope.currentBank.PayPreferentials&&0!==$scope.currentBank.PayPreferentials.length){var selPreferentials=$scope.currentBank.PayPreferentials.filter(function(item){return 1!==item.Source});selPreferentials&&selPreferentials.length>0&&(preferentialIds=selPreferentials.map(function(item){return item.PreferentialId.toString()}).reduce(function(pre,current){return pre+","+current}),preferentialTotalMoney=$scope.currentBank.PayPreferentials.map(function(item){return item.PreferentialMoney.toString()}).reduce(function(pre,current){return pre+","+current}))}else preferentialIds="",preferentialTotalMoney="";var parameters=JSON.stringify({needCheck:needCheck,orderCode:orderCode,orderID:$scope.paymentInfo.OrderDetail.UzaiOrder.OrderId,userId:userId,productId:$scope.paymentInfo.OrderDetail.UzaiOrder.ProductId,productName:encodeURI($scope.paymentInfo.OrderDetail.UzaiOrder.ProductName),productType:$scope.paymentInfo.OrderDetail.UzaiOrder.ProductType,supplierFlag:$scope.paymentInfo.OrderDetail.UzaiOrder.SupplierFlag,supplierNo:$scope.paymentInfo.OrderDetail.UzaiOrder.SupplierNo,goDate:$scope.paymentInfo.OrderDetail.UzaiOrder.GoDate,person:$scope.paymentInfo.OrderDetail.UzaiOrder.Person,child:$scope.paymentInfo.OrderDetail.UzaiOrder.Child,isUseCoupons:$scope.activeCodeInfo.disabled?!1:$scope.activeCodeInfo.isUseCoupons,couponsCode:$scope.activeCodeInfo.couponsCode,couponsMoney:$scope.activeCodeInfo.couponsPrice,couponsType:$scope.activeCodeInfo.couponsType,isUsePoint:$scope.pointInfo.disabled?!1:$scope.pointInfo.usePoint,point:$scope.pointInfo.point<0?0:parseInt($scope.pointInfo.point),PreferentialIds:preferentialIds,tuanId:tuanId,preferentialTotalMoney:preferentialTotalMoney,enable:$scope.paymentInfo.OrderDetail.UzaiOrder.Enable,state:$scope.paymentInfo.OrderDetail.UzaiOrder.State});api.post($http,$scope,api.path.mbuylogic,"Payment","CheckPayOrderDetail",parameters,function(data){hanlderResponse(data)&&$paycommon.mobilePay(orderCode,isSonOrder,tuanId,$scope.paymentInfo.OrderDetail.PayOrderID,preferentialIds,preferentialTotalMoney,$scope.currentBank.BankCode,userId)},0,!1)},$scope.clickMask=function(){$scope.showDetailMask&&($scope.showDetailMask=!1),$scope.showPoint&&($scope.showPoint=!1),$scope.showError&&($scope.showError=!1),$("body").css("overflow-y","scroll")},$scope.PageBack=function(url){api.routerGoBack()}}),uzai.filter("trustHtml",function($sce){return function(input){return $sce.trustAsHtml(input)}}),uzai.directive("selectcouponskeyong",function(){return{restrict:"AE",link:function(scope,elm,attr){scope.$last===!0&&($(".yours-coupons").on("click",".choose-coupons",function(){var $this=$(this);if($this.hasClass("activing"))scope.activeCodeInfo.isUseCoupons=!1,scope.activeCodeInfo.couponsPrice=0,scope.activeCodeInfo.couponsCode="",scope.activeCodeInfo.couponsType=0,scope.lijianPreferential?(scope.currentBank.PayPreferentials.push(scope.lijianPreferential),$("#chooseCoupons").html("与"+scope.lijianPreferential.PreferentialTypeName+"不可同享<i class='iconfont icon-right'></i>")):$("#chooseCoupons").html("未选择<i class='iconfont icon-right'></i>"),$this.toggleClass("activing");else{var activecode=$this.find("[type=hidden]").val(),couponsPrice=$this.find(".left .ng-binding").text();if(void 0!==couponsPrice&&null!==couponsPrice&&""!==couponsPrice){var type=$("#"+activecode).attr("ty"),coupons=0;if("2"===type){var maxPrice=$("#"+activecode).next().val();coupons=couponsPrice.split("折")[0],couponsPrice=parseInt(scope.paymentInfo.OrderDetail.UzaiOrder.TotalPrice-scope.paymentInfo.OrderDetail.UzaiOrder.TotalPrice*coupons/10),maxPrice&&couponsPrice>maxPrice&&(couponsPrice=maxPrice)}else if(couponsPrice=couponsPrice.split("￥")[1],couponsPrice>=scope.orderPrepayMent)return void api.toast("优惠>=应付，无法使用该优惠券",2e3);if(-1!==scope.con.ProjectName.indexOf("双旦"))return void api.toast("与优惠不可同享",2e3);if($("#chooseCoupons").html("已选抵 <em class='red'>"+couponsPrice+"</em> 元优惠券<i class='iconfont icon-right'></i><input type='hidden' id='activecode' value='"+activecode+"' />"),scope.activeCodeInfo.isUseCoupons=!0,scope.activeCodeInfo.couponsPrice=couponsPrice,scope.activeCodeInfo.couponsCode=activecode,scope.activeCodeInfo.couponsType=type,scope.lijianPreferential&&scope.activeCodeInfo.isUseCoupons)for(var i=0;i<scope.currentBank.PayPreferentials.length;i++){var preferential=scope.currentBank.PayPreferentials[i];preferential.PreferentialId===scope.lijianPreferential.PreferentialId&&scope.currentBank.PayPreferentials.splice(i,1)}}else scope.activeCodeInfo.isUseCoupons=!1,scope.activeCodeInfo.couponsPrice=0,scope.activeCodeInfo.couponsCode="",scope.activeCodeInfo.couponsType=0;$this.addClass("activing").siblings(".choose-coupons").removeClass("activing")}scope.calculatePrice(),location.href="#/",scope.$apply()}),$(".no-coupons .right>span,.choose-coupons .right>span").click(function(e){e.preventDefault(),e.stopPropagation();var $this=$(this);return $this.find("i").hasClass("active")?$this.find("i").removeClass("active").parents(".right").siblings(".explain").hide():$this.find("i").addClass("active").parents(".right").siblings(".explain").show()}))}}}),uzai.directive("selectcouponsbukeyong",function(){return{restrict:"AE",link:function(scope,elm,attr){scope.$last===!0&&($(".coupons-search .search .close").click(function(){var $this=$(this),$input=$this.prev(),$button=$(".coupons-search .button");$input.val(""),$button.removeClass("active")}),$(".no-coupons .right>span").click(function(){var $this=$(this);return $this.find("i").hasClass("active")?$this.find("i").removeClass("active").parents(".right").siblings(".explain").hide():$this.find("i").addClass("active").parents(".right").siblings(".explain").show()}))}}}),uzai.directive("selectCouponsInput",function(){return{restrict:"AE",link:function(scope,elm,attr){$("#J_router_selectcoupons").on("click",".coupons-search .search .close",function(){var $this=$(this),$input=$this.prev(),$button=$(".coupons-search .button");$input.val(""),$button.removeClass("active"),$this.hide()})}}}),uzai.directive("chooseMark",function(){return{restrict:"AE",link:function(scope,elm,attr){$(".coupons-header .mark").click(function(){$(".cal-mask").show(),$("#cal-pop").fadeIn()})}}}),document.addEventListener("touchmove",function(e){return document.getElementById("detailed-pop")&&$("#detailed-pop").offset().top>e.changedTouches[0].clientY?(e.preventDefault(),!1):document.getElementById("detailed-pop")&&$("#detailed-pop").offset().top+$("#detailed-pop").height()<e.changedTouches[0].clientY?(e.preventDefault(),!1):void 0})}(window,document,jQuery,uzai)},function(module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),PayCommon=function(){function PayCommon($http,$scope){_classCallCheck(this,PayCommon),this.$http=$http,this.$scope=$scope,this.devicetype=api.getQueryString("devicetype")||"wap"}return _createClass(PayCommon,[{key:"is_weixin",value:function(){var ua=navigator.userAgent.toLowerCase();return ua.indexOf("micromessenger")>-1}},{key:"GetBankPreferentialList",value:function(parameters,callback){var _this=this,_that=this,controller="",actionname="";""!==api.getUser().userId&&null!==api.getUser().userId&&"undefined"!=typeof api.getUser().userId?(controller="Payment",actionname="GetBankPreferentialList"):(controller="QuickPayLink",actionname="GetQuickPayLinkInit"),api.post(this.$http,this.$scope,api.path.mpaylogic,controller,actionname,parameters,function(data){if(_that.hanlderResponse(data)){if(data=JSON.parse(data.JsonResult),"7"===data.OrderDetail.UzaiOrder.Enable||"7"!==data.OrderDetail.UzaiOrder.Enable&&data.IsSonOrderPay===!0)api.toast("该笔付款已完成，请登录后查看订单状态!",2e3),setTimeout(function(){location.href="https://u.uzai.com/mobile/order"},2e3);else if("9"===data.OrderDetail.UzaiOrder.Enable)return void api.toast("该订单已取消，如需支付请重新下单!");if(_this.$scope.isshowapplepay=!1,_this.$scope.isios=!1,api.isApp()){var appversion=api.getCookie("appversion");if("5.5.6">appversion){var notGiftCard=function(element,index,array){return 10!==element.BankID};data.Banks=data.Banks.filter(notGiftCard)}if("ios"===devicetype){_this.$scope.isios=!0,_this.$scope.isbindbankcard=api.getCookie("isbindbankcard");var phonetype=api.getCookie("phonetype"),systemversion=api.getCookie("systemversion");if(systemversion&&systemversion.split(".").length<3)for(var i=0;i<3-systemversion.split(".").length;i++)systemversion+=".0";if(appversion>="5.5.2"&&Number("9.2.0".replace(/\./g,""))<=Number(systemversion.replace(/\./g,""))&&("iphone6"===phonetype||"iphone6s"===phonetype||"iphone6plus"===phonetype||"iphone6splus"===phonetype||"iphone7"===phonetype||"iphone7plus"===phonetype||"iphonese"===phonetype||"ipad"===phonetype)&&(_this.$scope.isshowapplepay=!0),!_this.$scope.isshowapplepay){var notapplepay=function(element,index,array){return 84!==element.BankID};data.Banks=data.Banks.filter(notapplepay),data.IsBankPref&&(data.PreferentialMoney=0);var notapplepaypref=function(element,index,array){return 32!==element.PreferentialType};data.OrderDetail.UzaiPreferentialRecord=data.OrderDetail.UzaiPreferentialRecord.filter(notapplepaypref)}}}if(_this.is_weixin()){var notalipay=function(element,index,array){return 45!==element.BankID};data.Banks=data.Banks.filter(notalipay),data.IsBankPref&&(data.PreferentialMoney=0);var notalipaypref=function(element,index,array){return 32!==element.PreferentialType};data.OrderDetail.UzaiPreferentialRecord=data.OrderDetail.UzaiPreferentialRecord.filter(notalipaypref);var openidkey=data.WeiXinOpenIdKey;if(_this.$scope.openidvalue=api.getCookie(openidkey),null===_this.$scope.openidvalue||""===_this.$scope.openidvalue||"undefined"==typeof _this.$scope.openidvalue){var checkurl="https://m.uzai.com/WeiXin/Authorization?MyUrl="+encodeURIComponent(decodeURIComponent(location.href).replace("#rd&","&").replace("#rd",""));location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+data.MWeiXinAppId+"&redirect_uri="+encodeURIComponent(checkurl)+"&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect"}}if(data.GetCustomTelList)for(var _i=0;_i<data.GetCustomTelList.length;_i++)1===data.GetCustomTelList[_i].Type?"ios"===devicetype&&(_this.$scope.Telphone=data.GetCustomTelList[_i].Telephone):2===data.GetCustomTelList[_i].Type?"android"===devicetype&&(_this.$scope.Telphone=data.GetCustomTelList[_i].Telephone):20===data.GetCustomTelList[_i].Type&&"ios"!==devicetype&&"android"!==devicetype&&(_this.$scope.Telphone=data.GetCustomTelList[_i].Telephone);callback(data)}},0,!1)}},{key:"mobilePay",value:function(orderCode,isSonOrder,tuanId,payOrderID,preferentialIds,preferentialTotalMoney,bankCode,userId){var bcmpayurl="https://mpay.uzai.com/pay/bcmpay.html?orderCode="+orderCode+"&orderId="+(isSonOrder?"02":"01")+payOrderID+"&tuanId="+(null===tuanId?0:tuanId)+"&preferentialIds="+preferentialIds+"&preferentialTotalMoney="+preferentialTotalMoney,flippedCardUrl="https://mpay.uzai.com/pay/flippedpay.html?orderCode="+orderCode+"&orderId="+this.$scope.paymentInfo.OrderDetail.UzaiOrder.OrderId,quickunionpayurl="https://mpay.uzai.com/pay/quickunionpay.html?orderCode="+orderCode+"&preferentialIds="+preferentialIds;if(api.isApp())if("BCM"===bankCode)window.location.href=bcmpayurl;else if("FlippedCard"===bankCode)window.location.href=flippedCardUrl;else if("QuickUnionPay"===bankCode)window.location.href=quickunionpayurl;else{var params={payType:bankCode,IsSSL:0,IsUtour:0,goDate:this.$scope.paymentInfo.OrderDetail.UzaiOrder.GoDate,nums:this.$scope.paymentInfo.OrderDetail.UzaiOrder.OrderPresonCount,orderCode:orderCode,orderId:payOrderID,pname:this.$scope.paymentInfo.OrderDetail.UzaiOrder.ProductName,prepayment:this.$scope.orderPrepayMent};bridge.invokeBankPay(params)}else{var param={OutOrderCode:payOrderID,UserId:userId,payType:bankCode,ClientIP:api.getCookie("spbill_create_ip")};switch(this.is_weixin()&&(param.OpenId=this.$scope.openidvalue),isSonOrder?param.OutOrderCode="02"+payOrderID:param.OutOrderCode="01"+payOrderID,param=JSON.stringify(param),bankCode){case"KQ":this.mpayRedirect("GetMKQPay",param);break;case"AliPay":this.mpayRedirect("GetMAliPay",param);break;case"MWeiXin":this.is_weixin()?this.mpayRedirect("GetMWeiXinPay",param):this.mpayRedirect("GetMArouseWinXinClientPay",param);break;case"BCM":window.location.href=bcmpayurl;break;case"QuickUnionPay":window.location.href=quickunionpayurl;break;case"FlippedCard":window.location.href=flippedCardUrl}}}},{key:"mpayRedirect",value:function(mpayaction,param){var _that=this;this.is_weixin()&&"MWeiXin"===JSON.parse(param).payType?api.post(this.$http,this.$scope,api.path.mpaylogic,"Payment",mpayaction,param,function(data){function onBridgeReady(){var payData=MPayRes;if(payData){var jsonData=payData;if("fail"===jsonData.return_code.toLowerCase())return void alert(jsonData.return_msg);if("fail"===jsonData.result_code.toLowerCase())return void alert(jsonData.err_code_des);window.WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:jsonData.appid,timeStamp:jsonData.timestamp,nonceStr:jsonData.nonce_str,"package":jsonData["package"],signType:jsonData.signType,paySign:jsonData.sign},function(res){"get_brand_wcpay_request:ok"===res.err_msg&&(api.toast("支付完成",1e3),location.href="https://u.uzai.com/mobile/order"),"get_brand_wcpay_request:cancel"===res.err_msg&&(api.toast("支付失败",1e3),location.href="https://u.uzai.com/mobile/order"),"get_brand_wcpay_request:fail"===res.err_msg&&(api.toast("支付失败",1e3),location.href="https://u.uzai.com/mobile/order")})}}if(api.loading(),_that.hanlderResponse(data)){var MPayRes=JSON.parse(data.JsonResult);"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady()}},0,!1):this.is_weixin()||"MWeiXin"!==JSON.parse(param).payType?api.post(this.$http,this.$scope,api.path.mpaylogic,"Payment",mpayaction,param,function(data){if(api.loading(),_that.hanlderResponse(data)){var MPayRes=JSON.parse(data.JsonResult),div=document.createElement("div");""!==MPayRes.MPayRes&&"undefined"!=typeof MPayRes.MPayRes&&(div.innerHTML=MPayRes.MPayRes.replace(/&plus/g,"+")),document.body.appendChild(div),document.forms[0].submit()}},0,!1):api.post(this.$http,this.$scope,api.path.mpaylogic,"Payment",mpayaction,param,function(data){if(api.loading(),!_that.hanlderResponse(data))return void api.endloading();var weixinjson=JSON.parse(data.JsonResult);if("success"===weixinjson.ReturnCode.toLowerCase()&&"success"===weixinjson.ResultCode.toLowerCase()){var mweburl=weixinjson.MwebUrl;window.location.href=mweburl}},0,!1)}},{key:"hanlderResponse",value:function(response){var _that=this;return 200===response.ErrorCode?!0:-3===response.ErrorCode?(api.toast("网络连接失败,请重试～"),!1):(-5===response.ErrorCode&&(api.toast(response.ErrorMsg,2e3),this.$scope.showPreferentials=!1,_that.GetBankPreferentialList(parameters)),-6===response.ErrorCode?(this.$scope.showError=!0,!1):(api.toast(response.ErrorMsg,2e3),!1))}},{key:"gaStatistics",value:function(data,orderCode){setTimeout(function(){var travelClass={1:"出境游",2:"国内游",3:"周边游",4:"签证",5:"酒店",6:"国内机票",7:"门票",8:"租车",9:"手机租赁",10:"自驾游",11:"机票+酒店",12:"巴士+酒店",13:"国内半自助",14:"一日游",15:"海外自由行",16:"国内自由行",17:"邮轮船票",18:"邮轮套餐",19:"自驾车+酒店",20:"接送机",21:"国际酒店",22:"国内酒店",23:"房型",24:"团队游(国内)",25:"手机",26:"附加产品",27:"团队游(出境)",28:"会员",29:"周边自由行",32:"国际机票",33:"供应商确认单",34:"其他业务收入",35:"资深",37:"wifi租赁",38:"国内私家团产品",39:"单项服务",40:"出境私家团产品",41:"特卖会产品",42:"国际火车",43:"要出发",44:"奇迹旅行"};try{window.ga("require","ecommerce","ecommerce.js"),window.ga("ecommerce:addTransaction",{id:orderCode,affiliation:"",revenue:data.OrderDetail.UzaiOrder.PrepayMent,shipping:"",tax:""}),window.ga("ecommerce:addItem",{id:orderCode,name:data.OrderDetail.UzaiOrder.ProductName,sku:data.OrderDetail.UzaiOrder.ProductId,category:travelClass[data.OrderDetail.UzaiOrder.UzaiTravelClassID],price:data.OrderDetail.UzaiOrder.PrepayMent,quantity:data.OrderDetail.UzaiOrder.Person+data.OrderDetail.UzaiOrder.Child}),window.ga("ecommerce:send")}catch(err){}},200)}}]),PayCommon}();exports.PayCommon=PayCommon}]);